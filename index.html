<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Food Group Tracker</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
    h1 { margin: 0 0 8px; }
    .muted { color: #555; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin: 14px 0 18px; }
    button { padding: 14px 12px; font-size: 16px; border-radius: 12px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    button:active { transform: translateY(1px); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 14px; margin: 10px 0; }
    .row { display: flex; justify-content: space-between; gap: 12px; align-items: baseline; flex-wrap: wrap; }
    .bar { height: 10px; background: #eee; border-radius: 999px; overflow: hidden; margin-top: 8px; }
    .bar > div { height: 10px; width: 0%; background: #111; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { text-align: left; padding: 8px; border-bottom: 1px solid #eee; }
    .right { text-align: right; }
    .pill { display:inline-block; padding: 2px 10px; border-radius: 999px; border: 1px solid #ddd; font-size: 12px; }
    .pill.ok { border-color: #0a0; color: #0a0; }
    .pill.warn { border-color: #c00; color: #c00; }
    .footer { margin-top: 18px; font-size: 13px; color: #555; }
    .tiny { font-size: 12px; color: #666; margin-top: 4px; }
    .err { color: #c00; white-space: pre-wrap; }
    input[type="text"] { width: 100%; max-width: 560px; padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; font-size: 14px; }
    .controls { margin: 10px 0 6px; }
  </style>
</head>
<body>
  <h1>Food Group Tracker</h1>
  <div class="muted">Tap a button to add <b>+1</b> for today. If today isn’t in the sheet yet, it will create it automatically.</div>

  <div class="controls">
    <div class="tiny"><b>Apps Script Web App URL</b> (paste your <code>.../exec</code> URL once, it’ll be saved in your browser)</div>
    <input id="scriptUrl" type="text" placeholder="https://script.google.com/macros/s/XXXXX/exec" />
    <div class="tiny">Tip: if you ever redeploy and your URL changes, paste the new one here.</div>
  </div>

  <div class="grid" id="buttons"></div>

  <div class="card">
    <div class="row">
      <div>
        <div><b>Today</b> <span class="pill" id="todayDate">—</span></div>
        <div class="muted">Progress vs daily targets</div>
      </div>
      <div class="muted" id="status">Not loaded yet</div>
    </div>
    <div id="todayCards"></div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <div><b>Last 7 days</b></div>
        <div class="muted">Totals vs weekly targets</div>
      </div>
      <div class="pill" id="sugarCapPill">Sugar weekly max: 10</div>
    </div>
    <div id="weekTable"></div>
  </div>

  <div class="footer">
    <div class="tiny">
      Notes:
      <ul>
        <li>Weekly view is a rolling last-7-days window.</li>
        <li>Vegetables target is scored against <b>3/day</b> (since it’s “3+”).</li>
        <li>Dairy target is scored against <b>2/day</b> (since it’s “1–2”).</li>
        <li>Sugar has a daily target of 1, and a weekly max of 10.</li>
      </ul>
    </div>
    <div class="err" id="error"></div>
  </div>

<script>
(() => {
  const GROUPS = [
    { key: 'Grains', label: 'Grains' },
    { key: 'Vegetables', label: 'Vegetables' },
    { key: 'Fruits', label: 'Fruits' },
    { key: 'Protein', label: 'Protein' },
    { key: 'Dairy', label: 'Dairy' },
    { key: 'Sugar', label: 'Sugar' },
  ];

  const LS_KEY = 'foodTracker_scriptUrl';

  const els = {
    buttons: document.getElementById('buttons'),
    todayDate: document.getElementById('todayDate'),
    status: document.getElementById('status'),
    todayCards: document.getElementById('todayCards'),
    weekTable: document.getElementById('weekTable'),
    sugarCapPill: document.getElementById('sugarCapPill'),
    error: document.getElementById('error'),
    scriptUrl: document.getElementById('scriptUrl'),
  };

  // Load stored script URL
  els.scriptUrl.value = localStorage.getItem(LS_KEY) || '';
  els.scriptUrl.addEventListener('change', () => {
    localStorage.setItem(LS_KEY, els.scriptUrl.value.trim());
    safeLoadSummary();
  });

  function getScriptUrl() {
    return (els.scriptUrl.value || '').trim().replace(/\/+$/, '');
  }

  function setError(msg) {
    els.error.textContent = msg || '';
  }

  function setStatus(msg) {
    els.status.textContent = msg || '';
  }

  function disableButtons(disabled) {
    [...els.buttons.querySelectorAll('button')].forEach(b => b.disabled = !!disabled);
  }

  function pct(n, d) {
    if (!d || d <= 0) return 0;
    return Math.max(0, Math.min(100, Math.round((n / d) * 100)));
  }

  function pillClass(current, target, isSugarWeekly=false) {
    // For sugar weekly, exceeding is "warn"
    if (isSugarWeekly) return current > target ? 'warn' : 'ok';
    return current >= target ? 'ok' : 'warn';
  }

  function ensureUrlOrExplain() {
    const url = getScriptUrl();
    if (!url) {
      setStatus('Paste your Apps Script Web App URL above to begin.');
      return null;
    }
    return url;
  }

  async function callApi(params) {
    const base = ensureUrlOrExplain();
    if (!base) throw new Error('Missing Apps Script Web App URL.');

    const u = new URL(base);
    Object.entries(params).forEach(([k, v]) => u.searchParams.set(k, v));

    const res = await fetch(u.toString(), { method: 'GET' });
    const data = await res.json();
    if (data && data.error) throw new Error(data.error);
    return data;
  }

  async function addOne(groupKey) {
    try {
      setError('');
      setStatus(`Adding +1 to ${groupKey}…`);
      disableButtons(true);
      const data = await callApi({ action: 'add', group: groupKey });
      render(data);
      setStatus(`Added +1 to ${groupKey}.`);
    } catch (e) {
      setStatus('Error');
      setError(String(e));
    } finally {
      disableButtons(false);
    }
  }

  async function safeLoadSummary() {
    try {
      setError('');
      const url = ensureUrlOrExplain();
      if (!url) return;
      setStatus('Loading…');
      disableButtons(true);
      const data = await callApi({ action: 'summary' });
      render(data);
      setStatus('Loaded.');
    } catch (e) {
      setStatus('Error');
      setError(String(e));
    } finally {
      disableButtons(false);
    }
  }

  function render(data) {
    if (!data) return;

    const targets = data.targets || {};
    const today = data.today || {};
    const last7 = data.last7 || {};

    els.todayDate.textContent = data.date || '—';

    // Today cards
    els.todayCards.innerHTML = '';
    GROUPS.forEach(g => {
      const t = targets[g.key]?.daily ?? 0;
      const v = today[g.key] ?? 0;
      const p = pct(v, t);

      const wrap = document.createElement('div');
      wrap.className = 'card';
      wrap.style.margin = '10px 0';

      const pill = document.createElement('span');
      pill.className = `pill ${pillClass(v, t)}`;
      pill.textContent = `${v} / ${t}`;

      wrap.innerHTML = `
        <div class="row">
          <div><b>${g.label}</b></div>
          <div class="right"></div>
        </div>
        <div class="bar"><div style="width:${p}%"></div></div>
        <div class="tiny">${p}% of daily target</div>
      `;
      wrap.querySelector('.right').appendChild(pill);
      els.todayCards.appendChild(wrap);
    });

    // Week table
    const rows = GROUPS.map(g => {
      const wt = targets[g.key]?.weekly ?? 0;
      const wv = last7[g.key] ?? 0;

      const isSugar = g.key === 'Sugar';
      const klass = pillClass(wv, wt, isSugar);
      const label = isSugar ? `${wv} / ${wt} (max)` : `${wv} / ${wt}`;

      return `
        <tr>
          <td><b>${g.label}</b></td>
          <td class="right"><span class="pill ${klass}">${label}</span></td>
        </tr>
      `;
    }).join('');

    els.weekTable.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Food Group</th>
            <th class="right">Last 7 days</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;

    // Sugar cap pill
    const sugarW = last7.Sugar ?? 0;
    const sugarTarget = targets.Sugar?.weekly ?? 10;
    els.sugarCapPill.className = `pill ${pillClass(sugarW, sugarTarget, true)}`;
    els.sugarCapPill.textContent = `Sugar weekly max: ${sugarTarget} (currently ${sugarW})`;
  }

  function initButtons() {
    els.buttons.innerHTML = '';
    GROUPS.forEach(g => {
      const b = document.createElement('button');
      b.textContent = `+1 ${g.label}`;
      b.addEventListener('click', () => addOne(g.key));
      els.buttons.appendChild(b);
    });
  }

  initButtons();
  safeLoadSummary();
})();
</script>
</body>
</html>
