<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Food Group Tracker</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
    h1 { margin: 0 0 8px; }
    .muted { color: #555; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin: 14px 0 18px; }
    button { padding: 14px 12px; font-size: 16px; border-radius: 12px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    button:active { transform: translateY(1px); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 14px; margin: 10px 0; }
    .row { display: flex; justify-content: space-between; gap: 12px; align-items: baseline; flex-wrap: wrap; }
    .bar { height: 10px; background: #eee; border-radius: 999px; overflow: hidden; margin-top: 8px; }
    .bar > div { height: 10px; width: 0%; background: #111; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { text-align: left; padding: 8px; border-bottom: 1px solid #eee; }
    .right { text-align: right; }
    .pill { display:inline-block; padding: 2px 10px; border-radius: 999px; border: 1px solid #ddd; font-size: 12px; }
    .pill.ok { border-color: #0a0; color: #0a0; }
    .pill.warn { border-color: #c00; color: #c00; }
    .footer { margin-top: 18px; font-size: 13px; color: #555; }
    .tiny { font-size: 12px; color: #666; margin-top: 4px; }
    .err { color: #c00; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Food Group Tracker</h1>
  <div class="muted">
    Tap a button to add <b>+1</b> for today.  
    If today isn’t in the sheet yet, it will be created automatically.
  </div>

  <div class="grid" id="buttons"></div>

  <div class="card">
    <div class="row">
      <div>
        <div><b>Today</b> <span class="pill" id="todayDate">—</span></div>
        <div class="muted">Progress vs daily targets</div>
      </div>
      <div class="muted" id="status">Loading…</div>
    </div>
    <div id="todayCards"></div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <div><b>Last 7 days</b></div>
        <div class="muted">Totals vs weekly targets</div>
      </div>
      <div class="pill" id="sugarCapPill">Sugar weekly max: 10</div>
    </div>
    <div id="weekTable"></div>
  </div>

  <div class="footer">
    <div class="tiny">
      <ul>
        <li>Weekly view is a rolling last-7-days window.</li>
        <li>Vegetables are scored against <b>3/day</b>.</li>
        <li>Dairy is scored against <b>2/day</b>.</li>
        <li>Sugar has a weekly max of <b>10</b>.</li>
      </ul>
    </div>
    <div class="err" id="error"></div>
  </div>

<script>
(() => {
  const SCRIPT_URL =
    'https://script.google.com/macros/s/AKfycbxV57pw311MKVdFW1y_PXK282jmZcWz6ePEpOf-iAM8TKYr5lwoHqj4DGahn0mkuQrIQQ/exec';

  const GROUPS = ['Grains','Vegetables','Fruits','Protein','Dairy','Sugar'];

  const els = {
    buttons: document.getElementById('buttons'),
    todayDate: document.getElementById('todayDate'),
    status: document.getElementById('status'),
    todayCards: document.getElementById('todayCards'),
    weekTable: document.getElementById('weekTable'),
    sugarCapPill: document.getElementById('sugarCapPill'),
    error: document.getElementById('error')
  };

  function pct(v, t) {
    return t > 0 ? Math.min(100, Math.round((v / t) * 100)) : 0;
  }

  function pillClass(v, t, cap=false) {
    return cap ? (v > t ? 'warn' : 'ok') : (v >= t ? 'ok' : 'warn');
  }

  async function api(params) {
    const u = new URL(SCRIPT_URL);
    Object.entries(params).forEach(([k,v]) => u.searchParams.set(k,v));
    const r = await fetch(u);
    const j = await r.json();
    if (j.error) throw new Error(j.error);
    return j;
  }

  async function addOne(group) {
    try {
      els.status.textContent = `Adding +1 ${group}…`;
      const data = await api({ action:'add', group });
      render(data.summary || data);
      els.status.textContent = `Added +1 ${group}`;
    } catch (e) {
      els.status.textContent = 'Error';
      els.error.textContent = e;
    }
  }

  async function load() {
    try {
      els.status.textContent = 'Loading…';
      const data = await api({ action:'summary' });
      render(data);
      els.status.textContent = 'Ready';
    } catch (e) {
      els.status.textContent = 'Error';
      els.error.textContent = e;
    }
  }

  function render(data) {
    const { targets, today, last7, date } = data;
    els.todayDate.textContent = date;

    els.todayCards.innerHTML = '';
    GROUPS.forEach(g => {
      const v = today[g] || 0;
      const t = targets[g].daily;
      const p = pct(v, t);

      els.todayCards.innerHTML += `
        <div class="card">
          <div class="row">
            <div><b>${g}</b></div>
            <div class="pill ${pillClass(v,t)}">${v} / ${t}</div>
          </div>
          <div class="bar"><div style="width:${p}%"></div></div>
          <div class="tiny">${p}% of daily target</div>
        </div>`;
    });

    els.weekTable.innerHTML = `
      <table>
        <thead><tr><th>Food Group</th><th class="right">Last 7 days</th></tr></thead>
        <tbody>
          ${GROUPS.map(g => {
            const v = last7[g] || 0;
            const t = targets[g].weekly;
            return `<tr>
              <td><b>${g}</b></td>
              <td class="right">
                <span class="pill ${pillClass(v,t,g==='Sugar')}">
                  ${v} / ${t}${g==='Sugar'?' max':''}
                </span>
              </td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>`;

    const s = last7.Sugar || 0;
    els.sugarCapPill.className = `pill ${pillClass(s, targets.Sugar.weekly, true)}`;
    els.sugarCapPill.textContent = `Sugar weekly max: ${targets.Sugar.weekly} (currently ${s})`;
  }

  GROUPS.forEach(g => {
    const b = document.createElement('button');
    b.textContent = `+1 ${g}`;
    b.onclick = () => addOne(g);
    els.buttons.appendChild(b);
  });

  load();
})();
</script>
</body>
</html>
